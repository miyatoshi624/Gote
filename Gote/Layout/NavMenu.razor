@inject ISupabaseService SupabaseService
@inject CategoryStateService CategoryService
@inject NavigationManager Navigation

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="top">Gote</a>
        <button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@_navMenuCssClass nav-scrollable" @onclick="ToggleNavMenu">
    <nav class="flex-column">
        @if (SupabaseService.IsSessionValid())
        {
            @if (CategoryService.Categories is null)
            {
                <div class="nav-item px-3">
                    <a class="nav-link" href="" @onclick:preventDefault="true">カテゴリを読み込み中...</a>
                </div>
                <div>カテゴリを読み込み中...</div>
            }
            else if (!CategoryService.Categories.Any())
            {
                <div class="nav-item px-3">
                    <a class="nav-link" href="" @onclick:preventDefault="true">カテゴリがありません</a>
                </div>
            }
            else
            {
                @foreach (Category category in CategoryService.Categories)
                {
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href=@($"list/{category.CategoryId}")>
                            @category.Name
                        </NavLink>
                    </div>
                }
            }
            <hr class="nav-hr mb-2" />
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="@($"edit")">新規作成</NavLink>
            </div>
            <hr class="nav-hr mb-2" />
            <div class="nav-item px-3">
                <a class="nav-link" href="" @onclick="SignOut" @onclick:preventDefault="true">ログアウト</a>
            </div>
        }
        else
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="@($"signup")">サインアップ</NavLink>
            </div>
        }
    </nav>
</div>

@code {
    /// <summary>
    /// メニューの折り畳み状態
    /// </summary>
    private bool _collapseNavMenu = true;
    /// <summary>
    /// メニューの折り畳み用CSSクラス定義
    /// </summary>
    private string? _navMenuCssClass => _collapseNavMenu ? "collapse" : null;

    /// <summary>
    /// 初期化処理
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        SupabaseService.OnAuthStateChanged += OnAuthStateChanged;
        CategoryService.OnCategoryStateChanged += OnCategoryStateChanged;
        if (SupabaseService.IsSessionValid())
        {
            await CategoryService.LoadCategoriesAsync();
        }
    }

    /// <summary>
    /// 認証状態変更イベントハンドラ
    /// </summary>
    private void OnAuthStateChanged()
    {
        if (SupabaseService.IsSessionValid())
        {
            _ = CategoryService.LoadCategoriesAsync();
        }
        else
        {
            InvokeAsync(StateHasChanged);
        }
    }

    /// <summary>
    /// カテゴリ状態変更イベントハンドラ
    /// </summary>
    private void OnCategoryStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// オブジェクト破棄時処理
    /// </summary>
    public void Dispose()
    {
        SupabaseService.OnAuthStateChanged -= OnAuthStateChanged;
        CategoryService.OnCategoryStateChanged -= OnCategoryStateChanged;
    }

    /// <summary>
    /// メニューの折り畳み設定
    /// </summary>
    private void ToggleNavMenu()
    {
        _collapseNavMenu = !_collapseNavMenu;
    }

    /// <summary>
    /// サインアウト処理
    /// </summary>
    private async void SignOut()
    {
        var result = await SupabaseService.SignOutAsync();
        result.Match(
            _ => Console.WriteLine("サインアウトに成功しました"),
            error => Console.Error.WriteLine($"サインアウトに失敗しました: {error.Message}")
        );
        Navigation.NavigateTo($"/");
    }
}
