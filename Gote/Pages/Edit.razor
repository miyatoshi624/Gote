@page "/edit"
@page "/edit/{CategoryId:guid}"
@page "/edit/{CategoryId:guid}/{MemoId:guid?}"
@using Markdig

@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject ISupabaseService SupabaseService
@inject CategoryStateService CategoryService

@if (string.IsNullOrEmpty(_errorMessage))
{
    if (_memo is not null)
    {
        <div class="edit-page-container">
            <div class="btn-toolbar mb-3">
                <div class="btn-group me-3">
                    <input type="radio" class="btn-check" name="btn-toolbar-check" id="btn-toolbar-check1" checked="@(_mode == Mode.preview)" @onchange="() => _mode = Mode.preview" />
                    <label class="btn btn-outline-dark" for="btn-toolbar-check1">表示</label>

                    <input type="radio" class="btn-check" name="btn-toolbar-check" id="btn-toolbar-check2" checked="@(_mode == Mode.edit)" @onchange="() => _mode = Mode.edit" />
                    <label class="btn btn-outline-dark" for="btn-toolbar-check2">編集</label>

                    <input type="radio" class="btn-check" name="btn-toolbar-check" id="btn-toolbar-check3" checked="@(_mode == Mode.category)" @onchange="() => _mode = Mode.category" />
                    <label class="btn btn-outline-dark" for="btn-toolbar-check3">カテゴリ</label>
                </div>
                <div class="btn-group me-3">
                    <button type="button" class="btn btn-outline-dark" @onclick="Cancel">戻る</button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" @onclick="Save">保存</button>
                </div>
            </div>

            <div class="edit-content-area">
                @if (_mode == Mode.preview)
                {
                    <div class="mb-3">
                        <div class="badge bg-secondary">@CategoryService.Categories?.FirstOrDefault(x => x.CategoryId == _memo.CategoryId)?.Name</div>
                    </div>
                    <div class="mb-3">
                        <div class="p-2">@_memo.Title</div>
                    </div>
                    <div class="mb-3">
                        <div class="p-2" @key="_memo.Content">
                            @((MarkupString)Markdown.ToHtml(_memo.Content ?? ""))
                        </div>
                    </div>
                }
                else if (_mode == Mode.edit)
                {
                    <div class="mb-3">
                        <select class="form-select" @bind="_memo.CategoryId">
                            @if (CategoryService.Categories is not null)
                            {
                                @foreach (var category in CategoryService.Categories)
                                {
                                    <option value="@category.CategoryId">
                                        @($"{category.Name} - {category.Description}")
                                    </option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <input class="form-control" @bind="_memo.Title" placeholder="タイトル" />
                    </div>
                    <div class="mb-3 textarea-wrapper">
                        <textarea class="form-control textarea-expand" @bind="_memo.Content" placeholder="内容"></textarea>
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <input class="form-control" @bind="_newCategoryName" placeholder="新しいカテゴリ名" />
                    </div>
                    <div class="mb-3">
                        <input class="form-control" @bind="_newCategoryDescription" placeholder="新しいカテゴリの説明" />
                    </div>
                    <button class="btn btn-primary mb-3 fit-content" @onclick="AddCategory">追加</button>
                    @if (CategoryService.Categories is not null)
                    {
                        <ul class="list-group">
                            @foreach (var category in CategoryService.Categories)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span><strong>@category.Name</strong></span>
                                        <div class="text-muted small">@category.Description</div>
                                    </div>
                                    <button class="btn btn-danger btn-sm" disabled="@category.IsReferenced" @onclick="() => ShowDeleteModal(category.CategoryId)">削除</button>
                                </li>
                            }
                        </ul>
                    }

                    <!-- 確認 -->
                    <div class="modal" id="delete-modal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">確認</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>カテゴリを削除します。</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">いいえ</button>
                                    <button type="button" class="btn btn-primary" @onclick="DeleteCategory">はい</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        window.showDeleteModal = function () {
                            const modalEl = document.getElementById('delete-modal');
                            if (modalEl) {
                                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                                modal.show();
                            }
                        }
                        window.hideDeleteModal = function () {
                            const modalEl = document.getElementById('delete-modal');
                            if (modalEl) {
                                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                                modal.hide();
                            }
                        }
                    </script>

                }
            </div>

        </div>

        <!-- メッセージ用 -->
        <div class="toast-container position-fixed bottom-0 p-3" style="z-index: 1100;">
            <div class="toast" id="message-toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">メッセージ</strong>
                    <small>今</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    @_message
                </div>
            </div>
        </div>

        <script>
            window.showToast = function () {
                const toastEl = document.getElementById('message-toast');
                if (toastEl) {
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
            }
        </script>
    }
    else
    {
        <div>読み込み中...</div>
    }
}
else
{
    <div class="alert alert-danger" role="alert">
        @_errorMessage
    </div>
}

@code {
    /// <summary>
    /// カテゴリID
    /// </summary>
    [Parameter]
    public Guid? CategoryId { get; set; }
    /// <summary>
    /// メモID
    /// </summary>
    [Parameter]
    public Guid? MemoId { get; set; }
    /// <summary>
    /// メモ
    /// </summary>
    private Memo? _memo;
    /// <summary>
    /// 表示モード列挙
    /// </summary>
    private enum Mode
    {
        preview,
        edit,
        category
    }
    /// <summary>
    /// 表示モード
    /// </summary>
    private Mode _mode = Mode.preview;
    /// <summary>
    /// メッセ―ジ
    /// </summary>
    private string _message = string.Empty;
    /// <summary>
    /// エラーメッセージ
    /// </summary>
    private string _errorMessage = string.Empty;
    /// <summary>
    /// 新しいカテゴリ名
    /// </summary>
    private string _newCategoryName = string.Empty;
    /// <summary>
    /// 新しいカテゴリ説明
    /// </summary>
    private string _newCategoryDescription = string.Empty;
    /// <summary>
    /// 削除対象カテゴリID
    /// </summary>
    private Guid? _deleteTargetCategoryId;

    /// <summary>
    /// パラメータ設定時処理
    /// </summary>
    /// <returns></returns>
    protected override async Task OnParametersSetAsync()
    {
        await CategoryService.LoadCategoriesAsync();

        // 更新
        if (MemoId.HasValue)
        {
            var result = await SupabaseService.GetMemoAsync(MemoId.Value);

            result.Match(
                memo => _memo = memo,
                error => _errorMessage = "メモの取得に失敗しました。"
            );

            _mode = Mode.preview;
        }
        // 新規作成
        else
        {
            var getUserIdResult = SupabaseService.GetUserId();
            if (getUserIdResult.IsSuccess)
            {
                Guid categoryId = CategoryId ?? (CategoryService.Categories?.FirstOrDefault()?.CategoryId ?? Guid.Empty);


                _memo = new Memo
                {
                    UserId = getUserIdResult.GetSuccess(),
                    CategoryId = categoryId,
                    Title = string.Empty,
                    Content = string.Empty,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                _mode = Mode.edit;
            }
            else
            {
                _errorMessage = getUserIdResult.GetFailure().Message;
            }
        }

        await base.OnParametersSetAsync();
    }

    /// <summary>
    /// 保存
    /// </summary>
    /// <returns></returns>
    private async Task Save()
    {
        if (_memo?.CategoryId is null)
        {
            _message = "カテゴリを選択してください。";
        }
        else if (string.IsNullOrEmpty(_memo?.Title))
        {
            _message = "タイトルを入力してください。";
        }
        else
        {
            // 更新
            if (MemoId.HasValue)
            {
                var result = await SupabaseService.UpdateMemoAsync(_memo!);
                result.Match(
                    memo => _message = "保存しました。",
                    error => _message = error.Message
                );
            }
            // 新規作成
            else
            {
                var result = await SupabaseService.CreateMemoAsync(_memo!);
                result.Match(
                    memo =>
                    {
                        _memo = memo;
                        _message = "保存しました。";
                    },
                    error => _message = error.Message
                );
            }
        }

        await JS.InvokeVoidAsync("showToast");
    }

    /// <summary>
    /// キャンセル
    /// </summary>
    private void Cancel()
    {
        if (_memo is null || CategoryService.Categories?.Any(x => x.CategoryId == _memo.CategoryId) == false)
        {
            Navigation.NavigateTo($"top");
        }
        else
        {
            Navigation.NavigateTo($"list/{_memo.CategoryId}");
        }
    }

    /// <summary>
    /// カテゴリ削除確認モーダル表示
    /// </summary>
    /// <param name="categoryId"></param>
    /// <returns></returns>
    private async Task ShowDeleteModal(Guid categoryId)
    {
        _deleteTargetCategoryId = categoryId;
        await JS.InvokeVoidAsync("showDeleteModal");
    }

    /// <summary>
    /// カテゴリ追加
    /// </summary>
    private async Task AddCategory()
    {
        var getUserIdResult = SupabaseService.GetUserId();
        if (getUserIdResult.IsSuccess)
        {
            var result = await CategoryService.AddCategoryAsync(new Category
            {
                UserId = getUserIdResult.GetSuccess(),
                Name = _newCategoryName,
                Description = _newCategoryDescription
            });

            result.Match(
                _ => _message = "カテゴリを追加しました。",
                error => _message = error.Message
            );

            _newCategoryName = string.Empty;
            _newCategoryDescription = string.Empty;
        }
        else
        {
            _message = getUserIdResult.GetFailure().Message;
        }

        await JS.InvokeVoidAsync("showToast");
    }

    /// <summary>
    /// カテゴリ削除
    /// </summary>
    private async Task DeleteCategory()
    {
        if (_deleteTargetCategoryId is null)
        {
            return;
        }

        var result = await CategoryService.DeleteCategoryAsync(_deleteTargetCategoryId.Value);

        result.Match(
            _ => _message = "カテゴリを削除しました。",
            error => _message = error.Message
        );

        _deleteTargetCategoryId = null;
        await JS.InvokeVoidAsync("hideDeleteModal");
        StateHasChanged();

        await JS.InvokeVoidAsync("showToast");
    }
}
